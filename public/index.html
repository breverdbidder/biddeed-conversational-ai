<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BidDeed.AI - Conversational Foreclosure Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --accent: #38bdf8;
  --accent-purple: #818cf8;
  --success: #22c55e;
  --warning: #eab308;
  --danger: #ef4444;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; overflow: hidden; }

/* Header */
.header {
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
  padding: 0.75rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--bg-tertiary);
  height: 60px;
}
.logo { display: flex; align-items: center; gap: 0.75rem; }
.logo-icon { 
  width: 36px; height: 36px; 
  background: linear-gradient(135deg, var(--accent), var(--accent-purple)); 
  border-radius: 10px; 
  display: flex; align-items: center; justify-content: center; 
  font-weight: 700; font-size: 1.1rem; 
}
.logo-text { 
  font-size: 1.25rem; font-weight: 700; 
  background: linear-gradient(135deg, var(--accent), var(--accent-purple)); 
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
}
.header-actions { display: flex; gap: 1rem; align-items: center; }
.status-badge {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.4rem 0.75rem;
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid rgba(34, 197, 94, 0.3);
  border-radius: 20px;
  font-size: 0.8rem;
  color: var(--success);
}
.status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Main Layout */
.main-container {
  display: flex;
  height: calc(100vh - 60px);
}

/* Chat Panel (Left) */
.chat-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--bg-tertiary);
  background: var(--bg-secondary);
}
.chat-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--bg-tertiary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chat-title { font-size: 1rem; font-weight: 600; }
.voice-btn {
  width: 40px; height: 40px;
  border-radius: 50%;
  border: 2px solid var(--accent);
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}
.voice-btn:hover { background: var(--accent); color: var(--bg-primary); }
.voice-btn.listening { background: var(--danger); border-color: var(--danger); color: white; animation: pulseVoice 1s infinite; }
@keyframes pulseVoice { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.message {
  max-width: 85%;
  padding: 1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  line-height: 1.5;
}
.message.user {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--accent), var(--accent-purple));
  color: white;
}
.message.assistant {
  align-self: flex-start;
  background: var(--bg-primary);
  border: 1px solid var(--bg-tertiary);
}
.message.system {
  align-self: center;
  background: rgba(129, 140, 248, 0.1);
  border: 1px solid rgba(129, 140, 248, 0.3);
  color: var(--accent-purple);
  font-size: 0.8rem;
  padding: 0.5rem 1rem;
}
.message-content { white-space: pre-wrap; }
.message-time { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem; }

.chat-input-area {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--bg-tertiary);
  background: var(--bg-primary);
}
.quick-actions {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}
.quick-btn {
  padding: 0.4rem 0.75rem;
  border-radius: 20px;
  border: 1px solid var(--bg-tertiary);
  background: transparent;
  color: var(--text-secondary);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
}
.quick-btn:hover { border-color: var(--accent); color: var(--accent); }
.input-row {
  display: flex;
  gap: 0.75rem;
}
.chat-input {
  flex: 1;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  border: 1px solid var(--bg-tertiary);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 0.9rem;
  resize: none;
  height: 48px;
  font-family: inherit;
}
.chat-input:focus { outline: none; border-color: var(--accent); }
.send-btn {
  width: 48px; height: 48px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, var(--accent), var(--accent-purple));
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}
.send-btn:hover { transform: scale(1.05); }
.send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Agent Panel (Right) */
.agent-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
}
.agent-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--bg-tertiary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.agent-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
.agent-status { font-size: 0.8rem; color: var(--text-secondary); }

.agent-tabs {
  display: flex;
  border-bottom: 1px solid var(--bg-tertiary);
  padding: 0 1rem;
}
.agent-tab {
  padding: 0.75rem 1.25rem;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 0.85rem;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.agent-tab:hover { color: var(--text-primary); }
.agent-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.agent-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem 1.5rem;
}

/* Activity Feed */
.activity-feed { display: flex; flex-direction: column; gap: 0.75rem; }
.activity-item {
  display: flex;
  gap: 0.75rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 10px;
  border-left: 3px solid var(--accent);
}
.activity-item.search { border-left-color: var(--accent-purple); }
.activity-item.analysis { border-left-color: var(--success); }
.activity-item.warning { border-left-color: var(--warning); }
.activity-item.error { border-left-color: var(--danger); }
.activity-icon {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  flex-shrink: 0;
}
.activity-body { flex: 1; min-width: 0; }
.activity-title { font-size: 0.85rem; font-weight: 500; margin-bottom: 0.25rem; }
.activity-desc { font-size: 0.75rem; color: var(--text-secondary); }
.activity-time { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; }

/* Property Cards */
.property-results { display: flex; flex-direction: column; gap: 0.75rem; }
.result-card {
  background: var(--bg-secondary);
  border-radius: 10px;
  padding: 1rem;
  border: 1px solid var(--bg-tertiary);
  cursor: pointer;
  transition: all 0.2s;
}
.result-card:hover { border-color: var(--accent); transform: translateX(4px); }
.result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.result-address { font-weight: 600; font-size: 0.9rem; }
.result-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
}
.result-badge.bid { background: rgba(34, 197, 94, 0.2); color: var(--success); }
.result-badge.review { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
.result-badge.skip { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.result-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.8rem; }
.result-detail { display: flex; justify-content: space-between; }
.result-label { color: var(--text-secondary); }
.result-value { font-weight: 500; }

/* Pipeline Progress */
.pipeline-container { padding: 1rem 0; }
.pipeline-stage {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 0;
}
.stage-indicator {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}
.stage-indicator.active { background: var(--accent); color: white; animation: pulseStage 1.5s infinite; }
.stage-indicator.complete { background: var(--success); color: white; }
@keyframes pulseStage { 0%, 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(56, 189, 248, 0); } }
.stage-info { flex: 1; }
.stage-name { font-size: 0.85rem; font-weight: 500; }
.stage-status { font-size: 0.75rem; color: var(--text-secondary); }

/* Mobile */
@media (max-width: 900px) {
  .main-container { flex-direction: column; }
  .chat-panel, .agent-panel { width: 100%; height: 50%; }
}

/* Typing indicator */
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 0.75rem 1rem;
  background: var(--bg-primary);
  border-radius: 12px;
  width: fit-content;
}
.typing-dot {
  width: 8px; height: 8px;
  background: var(--accent);
  border-radius: 50%;
  animation: typingBounce 1.4s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">B</div>
    <span class="logo-text">BidDeed.AI</span>
  </div>
  <div class="header-actions">
    <div class="status-badge">
      <span class="status-dot"></span>
      <span>Agent Active</span>
    </div>
  </div>
</header>

<div class="main-container">
  <!-- Chat Panel -->
  <div class="chat-panel">
    <div class="chat-header">
      <span class="chat-title">üí¨ Foreclosure Assistant</span>
      <button class="voice-btn" id="voiceBtn" title="Voice Input">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      </button>
    </div>
    
    <div class="messages" id="messages">
      <div class="message system">
        üè† Welcome to BidDeed.AI Foreclosure Agent. Ask me anything about Brevard County auctions!
      </div>
      <div class="message assistant">
        <div class="message-content">Hi! I'm your foreclosure research assistant. I can help you:

‚Ä¢ Find properties in upcoming auctions
‚Ä¢ Analyze lien priority and title issues  
‚Ä¢ Calculate max bid recommendations
‚Ä¢ Research plaintiff patterns and third-party probabilities

What would you like to explore today?</div>
        <div class="message-time">Just now</div>
      </div>
    </div>
    
    <div class="chat-input-area">
      <div class="quick-actions">
        <button class="quick-btn" onclick="sendQuickQuery('Show me BID properties for Jan 7')">üü¢ BID Properties</button>
        <button class="quick-btn" onclick="sendQuickQuery('Analyze 923 Slocum St Palm Bay')">üîç Analyze Property</button>
        <button class="quick-btn" onclick="sendQuickQuery('What plaintiffs have highest third-party rates?')">üìä Plaintiff Analysis</button>
        <button class="quick-btn" onclick="sendQuickQuery('Run full pipeline on next auction')">‚ö° Run Pipeline</button>
      </div>
      <div class="input-row">
        <textarea class="chat-input" id="chatInput" placeholder="Ask about foreclosures, properties, or run analysis..." onkeydown="handleKeyDown(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Agent Panel -->
  <div class="agent-panel">
    <div class="agent-header">
      <div class="agent-title">
        <span>ü§ñ Agent Workspace</span>
      </div>
      <div class="agent-status" id="agentStatus">Idle</div>
    </div>
    
    <div class="agent-tabs">
      <button class="agent-tab active" data-tab="activity" onclick="switchTab('activity')">Activity</button>
      <button class="agent-tab" data-tab="results" onclick="switchTab('results')">Results</button>
      <button class="agent-tab" data-tab="pipeline" onclick="switchTab('pipeline')">Pipeline</button>
    </div>
    
    <div class="agent-content">
      <!-- Activity Tab -->
      <div id="activityTab" class="activity-feed">
        <div class="activity-item">
          <div class="activity-icon">üöÄ</div>
          <div class="activity-body">
            <div class="activity-title">System Initialized</div>
            <div class="activity-desc">BidDeed.AI Conversational Agent ready</div>
            <div class="activity-time">Just now</div>
          </div>
        </div>
        <div class="activity-item search">
          <div class="activity-icon">üìä</div>
          <div class="activity-body">
            <div class="activity-title">Data Loaded</div>
            <div class="activity-desc">22 foreclosure properties in memory</div>
            <div class="activity-time">Just now</div>
          </div>
        </div>
      </div>
      
      <!-- Results Tab -->
      <div id="resultsTab" class="property-results" style="display:none;">
        <div class="result-card">
          <div class="result-header">
            <div class="result-address">925 ATLANTUS TER, Satellite Beach</div>
            <span class="result-badge bid">BID</span>
          </div>
          <div class="result-details">
            <div class="result-detail"><span class="result-label">Judgment</span><span class="result-value">$425,000</span></div>
            <div class="result-detail"><span class="result-label">Max Bid</span><span class="result-value">$340,000</span></div>
            <div class="result-detail"><span class="result-label">ML Score</span><span class="result-value">85%</span></div>
            <div class="result-detail"><span class="result-label">Auction</span><span class="result-value">Jan 7, 2025</span></div>
          </div>
        </div>
        <div class="result-card">
          <div class="result-header">
            <div class="result-address">4521 N ATLANTIC AVE, Cocoa Beach</div>
            <span class="result-badge bid">BID</span>
          </div>
          <div class="result-details">
            <div class="result-detail"><span class="result-label">Judgment</span><span class="result-value">$520,000</span></div>
            <div class="result-detail"><span class="result-label">Max Bid</span><span class="result-value">$416,000</span></div>
            <div class="result-detail"><span class="result-label">ML Score</span><span class="result-value">82%</span></div>
            <div class="result-detail"><span class="result-label">Auction</span><span class="result-value">Jan 7, 2025</span></div>
          </div>
        </div>
      </div>
      
      <!-- Pipeline Tab -->
      <div id="pipelineTab" class="pipeline-container" style="display:none;">
        <div class="pipeline-stage">
          <div class="stage-indicator complete">‚úì</div>
          <div class="stage-info"><div class="stage-name">1. Discovery</div><div class="stage-status">22 properties found</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator complete">‚úì</div>
          <div class="stage-info"><div class="stage-name">2. Scraping</div><div class="stage-status">BCPAO data enriched</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">3</div>
          <div class="stage-info"><div class="stage-name">3. Title Search</div><div class="stage-status">Pending</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">4</div>
          <div class="stage-info"><div class="stage-name">4. Lien Priority</div><div class="stage-status">Pending</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">5</div>
          <div class="stage-info"><div class="stage-name">5. Tax Certificates</div><div class="stage-status">Pending</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">6</div>
          <div class="stage-info"><div class="stage-name">6. Demographics</div><div class="stage-status">Pending</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">7</div>
          <div class="stage-info"><div class="stage-name">7. ML Scoring</div><div class="stage-status">Pending</div></div>
        </div>
        <div class="pipeline-stage">
          <div class="stage-indicator">8</div>
          <div class="stage-info"><div class="stage-name">8. Max Bid Calc</div><div class="stage-status">Pending</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Foreclosure data
const FORECLOSURES = [
  {c:"05-2024-CA-029012",a:"2450 PALM BAY RD NE, PALM BAY",j:185000,m:147000,r:"BID",s:0.99,d:"2025-12-03",p:"Freedom Mortgage"},
  {c:"05-2024-CA-014947",a:"808 EMERSON DR, PALM BAY",j:219655,m:175724,r:"BID",s:0.81,d:"2025-12-17",p:"LAKEVIEW LOAN"},
  {c:"05-2024-CA-048653",a:"775 JACARANDA ST, MERRITT ISLAND",j:110864,m:88691,r:"BID",s:0.78,d:"2025-12-17",p:"DATA MORTGAGE"},
  {c:"05-2025-CA-013384",a:"2551 STRATFORD DR, COCOA",j:166431,m:133145,r:"BID",s:0.82,d:"2025-12-17",p:"HUNTINGTON"},
  {c:"05-2025-CA-022257",a:"923 SLOCUM ST, PALM BAY",j:143880,m:115104,r:"BID",s:0.79,d:"2025-12-17",p:"US BANK"},
  {c:"05-2025-CA-026675",a:"4461 LONGBOW DR, TITUSVILLE",j:224779,m:179823,r:"BID",s:0.83,d:"2025-12-17",p:"NEWREZ"},
  {c:"05-2025-CA-034578",a:"520 HOLMES AVE, PALM BAY",j:268305,m:214644,r:"BID",s:0.76,d:"2025-12-17",p:"UNITED WHOLESALE"},
  {c:"05-2024-CA-045234",a:"925 ATLANTUS TER, SATELLITE BEACH",j:425000,m:340000,r:"BID",s:0.85,d:"2025-01-07",p:"NATIONSTAR"},
  {c:"05-2024-CA-045567",a:"4521 N ATLANTIC AVE, COCOA BEACH",j:520000,m:416000,r:"BID",s:0.82,d:"2025-01-07",p:"JPMORGAN CHASE"},
  {c:"05-2024-CA-045789",a:"987 VIERA BLVD, VIERA",j:485000,m:388000,r:"BID",s:0.85,d:"2025-01-07",p:"LOANCARE"},
  {c:"05-2022-CA-035649",a:"5600 GRAHAM ST, COCOA",j:279230,m:161612,r:"REVIEW",s:0.003,d:"2025-12-03",p:"US Bank NA"},
  {c:"05-2024-CA-018884",a:"906 SHAW CIR, MELBOURNE",j:372130,m:186065,r:"REVIEW",s:0.45,d:"2025-12-03",p:"Lakeview Loan"},
  {c:"05-2018-CA-050709",a:"4920 BROOKHAVEN ST, COCOA",j:74346,m:52042,r:"REVIEW",s:0.65,d:"2025-12-17",p:"MTGLQ INVEST"},
  {c:"05-2023-CA-044476",a:"2100 LEEWOOD BLVD, MELBOURNE",j:232556,m:162789,r:"REVIEW",s:0.72,d:"2025-12-17",p:"NATIONSTAR"},
  {c:"05-2024-CA-051335",a:"1001 ORIOLE CIR, BAREFOOT BAY",j:325000,m:227500,r:"REVIEW",s:0.55,d:"2025-12-17",p:"EVELYN SIMEON"},
  {c:"05-2025-CA-017191",a:"3625 MIRIAM DR, TITUSVILLE",j:334505,m:234153,r:"REVIEW",s:0.68,d:"2025-12-17",p:"CITIZENS BANK"},
  {c:"05-2025-CA-024879",a:"661 BRISBANE ST, PALM BAY",j:281528,m:197070,r:"REVIEW",s:0.71,d:"2025-12-17",p:"DATA MORT"},
  {c:"05-2024-CA-045123",a:"1847 DOOLITTLE LN, TITUSVILLE",j:287500,m:201250,r:"REVIEW",s:0.68,d:"2025-01-07",p:"WELLS FARGO"},
  {c:"05-2024-CA-024562",a:"8520 HIGHWAY 1, MICCO",j:25550,m:16250,r:"SKIP",s:0.003,d:"2025-12-03",p:"Bank of NY Mellon"},
  {c:"05-2024-CA-031234",a:"2085 ROBIN HOOD DR, MELBOURNE",j:176240,m:88120,r:"SKIP",s:0.003,d:"2025-12-03",p:"Bank of America"},
  {c:"05-2024-CA-031697",a:"1160 TIGER ST SE, PALM BAY",j:253150,m:126575,r:"SKIP",s:0.003,d:"2025-12-03",p:"Nationstar"},
  {c:"05-2025-CC-017102",a:"1404 PARADISE LN, COCOA",j:24520,m:17164,r:"SKIP",s:0.42,d:"2025-12-17",p:"NORTHFIELD"}
];

// NLP Query Parser
function parseQuery(query) {
  const q = query.toLowerCase();
  const intent = {
    type: 'general',
    filters: {},
    entities: []
  };
  
  // Detect intent type
  if (q.includes('bid') && (q.includes('show') || q.includes('find') || q.includes('list'))) {
    intent.type = 'search';
    intent.filters.recommendation = 'BID';
  } else if (q.includes('review') && (q.includes('show') || q.includes('find'))) {
    intent.type = 'search';
    intent.filters.recommendation = 'REVIEW';
  } else if (q.includes('skip') && (q.includes('show') || q.includes('find'))) {
    intent.type = 'search';
    intent.filters.recommendation = 'SKIP';
  } else if (q.includes('analyze') || q.includes('analysis')) {
    intent.type = 'analyze';
  } else if (q.includes('plaintiff')) {
    intent.type = 'plaintiff_analysis';
  } else if (q.includes('pipeline') || q.includes('run')) {
    intent.type = 'pipeline';
  } else if (q.includes('lien') || q.includes('title')) {
    intent.type = 'lien_analysis';
  }
  
  // Extract date filters
  if (q.includes('jan 7') || q.includes('january 7') || q.includes('01-07')) {
    intent.filters.date = '2025-01-07';
  } else if (q.includes('dec 17') || q.includes('december 17')) {
    intent.filters.date = '2025-12-17';
  } else if (q.includes('dec 3') || q.includes('december 3')) {
    intent.filters.date = '2025-12-03';
  }
  
  // Extract address
  const addressMatch = q.match(/(\d+\s+[\w\s]+(?:st|ave|dr|blvd|rd|ln|ter|cir))/i);
  if (addressMatch) {
    intent.entities.push({ type: 'address', value: addressMatch[1].toUpperCase() });
  }
  
  // Extract city
  const cities = ['palm bay', 'melbourne', 'cocoa', 'titusville', 'satellite beach', 'merritt island', 'viera', 'cocoa beach'];
  for (const city of cities) {
    if (q.includes(city)) {
      intent.filters.city = city.toUpperCase();
      break;
    }
  }
  
  return intent;
}

// Generate response based on parsed intent
function generateResponse(intent, query) {
  let response = '';
  let results = [];
  
  switch (intent.type) {
    case 'search':
      results = FORECLOSURES.filter(p => {
        let match = true;
        if (intent.filters.recommendation) match = match && p.r === intent.filters.recommendation;
        if (intent.filters.date) match = match && p.d === intent.filters.date;
        if (intent.filters.city) match = match && p.a.includes(intent.filters.city);
        return match;
      });
      
      if (results.length > 0) {
        response = `Found **${results.length} ${intent.filters.recommendation || ''} properties**${intent.filters.date ? ` for ${intent.filters.date}` : ''}:\n\n`;
        results.slice(0, 5).forEach(p => {
          response += `üè† **${p.a}**\n`;
          response += `   Judgment: $${p.j.toLocaleString()} | Max Bid: $${p.m.toLocaleString()} | ML: ${(p.s*100).toFixed(0)}%\n\n`;
        });
        if (results.length > 5) {
          response += `\n... and ${results.length - 5} more. Check the Results tab for all properties.`;
        }
        updateResults(results);
      } else {
        response = "No properties found matching your criteria. Try adjusting your search filters.";
      }
      break;
      
    case 'analyze':
      if (intent.entities.length > 0) {
        const addr = intent.entities[0].value;
        const prop = FORECLOSURES.find(p => p.a.includes(addr));
        if (prop) {
          response = `## Property Analysis: ${prop.a}\n\n`;
          response += `**Case Number:** ${prop.c}\n`;
          response += `**Plaintiff:** ${prop.p}\n`;
          response += `**Judgment Amount:** $${prop.j.toLocaleString()}\n`;
          response += `**Max Bid Recommendation:** $${prop.m.toLocaleString()}\n`;
          response += `**ML Third-Party Probability:** ${(prop.s*100).toFixed(0)}%\n`;
          response += `**Recommendation:** ${prop.r}\n`;
          response += `**Auction Date:** ${prop.d}\n\n`;
          
          const ratio = (prop.m / prop.j * 100).toFixed(0);
          response += `**Bid/Judgment Ratio:** ${ratio}%\n`;
          response += prop.r === 'BID' ? '\n‚úÖ This property meets BID criteria with good equity spread.' : 
                     prop.r === 'REVIEW' ? '\n‚ö†Ô∏è This property needs manual review before bidding.' :
                     '\n‚ùå This property is recommended to SKIP.';
          
          addActivity('analysis', `Analyzed ${prop.a}`, `${prop.r} recommendation, ${ratio}% bid ratio`);
        } else {
          response = `I couldn't find a property matching "${addr}". Please check the address and try again.`;
        }
      } else {
        response = "Please specify a property address to analyze. Example: 'Analyze 923 Slocum St Palm Bay'";
      }
      break;
      
    case 'plaintiff_analysis':
      const plaintiffStats = {};
      FORECLOSURES.forEach(p => {
        if (!plaintiffStats[p.p]) {
          plaintiffStats[p.p] = { count: 0, totalJudgment: 0, avgML: 0, mlSum: 0 };
        }
        plaintiffStats[p.p].count++;
        plaintiffStats[p.p].totalJudgment += p.j;
        plaintiffStats[p.p].mlSum += p.s;
      });
      
      response = "## Plaintiff Analysis (Current Auctions)\n\n";
      const sorted = Object.entries(plaintiffStats)
        .map(([name, stats]) => ({ name, ...stats, avgML: stats.mlSum / stats.count }))
        .sort((a, b) => b.avgML - a.avgML);
      
      response += "**Highest Third-Party Probability:**\n";
      sorted.slice(0, 5).forEach((p, i) => {
        response += `${i+1}. **${p.name}** - ${(p.avgML*100).toFixed(0)}% avg ML score (${p.count} properties)\n`;
      });
      
      addActivity('analysis', 'Plaintiff Analysis Complete', `${Object.keys(plaintiffStats).length} unique plaintiffs analyzed`);
      break;
      
    case 'pipeline':
      response = "üöÄ **Starting Everest Ascent Pipeline...**\n\n";
      response += "The 12-stage pipeline will:\n";
      response += "1. Discover properties from RealForeclose\n";
      response += "2. Scrape BCPAO for property details\n";
      response += "3. Search AcclaimWeb for title records\n";
      response += "4. Analyze lien priority\n";
      response += "5. Check tax certificates\n";
      response += "6. Pull demographics data\n";
      response += "7. Run ML scoring model\n";
      response += "8. Calculate max bids\n";
      response += "9-12. Generate reports & archive\n\n";
      response += "Check the **Pipeline** tab to monitor progress.";
      
      startPipelineAnimation();
      break;
      
    case 'lien_analysis':
      response = "## Lien Priority Analysis\n\n";
      response += "In Florida foreclosures, lien priority is critical:\n\n";
      response += "**Priority Order:**\n";
      response += "1. Property taxes (always senior)\n";
      response += "2. First mortgage (if mortgage foreclosure)\n";
      response += "3. HOA/COA liens (can be super-lien in some cases)\n";
      response += "4. Second mortgages, HELOCs\n";
      response += "5. Judgment liens\n\n";
      response += "‚ö†Ô∏è **HOA Foreclosures:** If plaintiff is HOA, the senior mortgage typically SURVIVES the sale.\n\n";
      response += "Our pipeline automatically checks AcclaimWeb for recorded mortgages and flags DO_NOT_BID for risky lien situations.";
      
      addActivity('search', 'Lien Priority Info Provided', 'Educational response');
      break;
      
    default:
      response = "I can help you with:\n\n";
      response += "‚Ä¢ **Search properties:** 'Show me BID properties for Jan 7'\n";
      response += "‚Ä¢ **Analyze specific property:** 'Analyze 923 Slocum St'\n";
      response += "‚Ä¢ **Plaintiff patterns:** 'Which plaintiffs have highest third-party rates?'\n";
      response += "‚Ä¢ **Run pipeline:** 'Run full pipeline on next auction'\n";
      response += "‚Ä¢ **Lien info:** 'Explain lien priority in foreclosures'\n\n";
      response += "What would you like to explore?";
  }
  
  return response;
}

// UI Functions
function addMessage(content, role) {
  const messages = document.getElementById('messages');
  const msg = document.createElement('div');
  msg.className = `message ${role}`;
  msg.innerHTML = `
    <div class="message-content">${content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>
    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
  `;
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}

function addTypingIndicator() {
  const messages = document.getElementById('messages');
  const typing = document.createElement('div');
  typing.className = 'typing-indicator';
  typing.id = 'typingIndicator';
  typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  messages.appendChild(typing);
  messages.scrollTop = messages.scrollHeight;
}

function removeTypingIndicator() {
  const typing = document.getElementById('typingIndicator');
  if (typing) typing.remove();
}

function addActivity(type, title, desc) {
  const feed = document.getElementById('activityTab');
  const item = document.createElement('div');
  item.className = `activity-item ${type}`;
  
  const icons = { search: 'üîç', analysis: 'üìä', warning: '‚ö†Ô∏è', error: '‚ùå', default: 'üìå' };
  
  item.innerHTML = `
    <div class="activity-icon">${icons[type] || icons.default}</div>
    <div class="activity-body">
      <div class="activity-title">${title}</div>
      <div class="activity-desc">${desc}</div>
      <div class="activity-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
    </div>
  `;
  feed.insertBefore(item, feed.firstChild);
}

function updateResults(results) {
  const container = document.getElementById('resultsTab');
  container.innerHTML = '';
  
  results.forEach(p => {
    const card = document.createElement('div');
    card.className = 'result-card';
    card.innerHTML = `
      <div class="result-header">
        <div class="result-address">${p.a}</div>
        <span class="result-badge ${p.r.toLowerCase()}">${p.r}</span>
      </div>
      <div class="result-details">
        <div class="result-detail"><span class="result-label">Judgment</span><span class="result-value">$${p.j.toLocaleString()}</span></div>
        <div class="result-detail"><span class="result-label">Max Bid</span><span class="result-value">$${p.m.toLocaleString()}</span></div>
        <div class="result-detail"><span class="result-label">ML Score</span><span class="result-value">${(p.s*100).toFixed(0)}%</span></div>
        <div class="result-detail"><span class="result-label">Auction</span><span class="result-value">${p.d}</span></div>
      </div>
    `;
    container.appendChild(card);
  });
  
  switchTab('results');
}

function startPipelineAnimation() {
  switchTab('pipeline');
  const stages = document.querySelectorAll('.stage-indicator');
  let currentStage = 2;
  
  function activateStage() {
    if (currentStage < stages.length) {
      stages[currentStage].classList.add('active');
      stages[currentStage].classList.remove('complete');
      document.getElementById('agentStatus').textContent = `Running Stage ${currentStage + 1}...`;
      addActivity('search', `Stage ${currentStage + 1} Started`, stages[currentStage].parentElement.querySelector('.stage-name').textContent);
      
      setTimeout(() => {
        stages[currentStage].classList.remove('active');
        stages[currentStage].classList.add('complete');
        stages[currentStage].textContent = '‚úì';
        currentStage++;
        
        if (currentStage < stages.length) {
          activateStage();
        } else {
          document.getElementById('agentStatus').textContent = 'Pipeline Complete';
          addActivity('analysis', 'Pipeline Complete', 'All 8 stages finished successfully');
        }
      }, 1500);
    }
  }
  
  activateStage();
}

function switchTab(tabName) {
  document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  
  document.getElementById('activityTab').style.display = tabName === 'activity' ? 'flex' : 'none';
  document.getElementById('resultsTab').style.display = tabName === 'results' ? 'flex' : 'none';
  document.getElementById('pipelineTab').style.display = tabName === 'pipeline' ? 'block' : 'none';
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const query = input.value.trim();
  if (!query) return;
  
  addMessage(query, 'user');
  input.value = '';
  
  document.getElementById('agentStatus').textContent = 'Processing...';
  addTypingIndicator();
  addActivity('search', 'Processing Query', query.substring(0, 50) + '...');
  
  // Simulate processing delay
  await new Promise(r => setTimeout(r, 800 + Math.random() * 700));
  
  const intent = parseQuery(query);
  const response = generateResponse(intent, query);
  
  removeTypingIndicator();
  addMessage(response, 'assistant');
  document.getElementById('agentStatus').textContent = 'Idle';
}

function sendQuickQuery(query) {
  document.getElementById('chatInput').value = query;
  sendMessage();
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// Voice Recognition
let recognition = null;
let isListening = false;

function initVoice() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    
    recognition.onresult = (e) => {
      const transcript = Array.from(e.results)
        .map(r => r[0].transcript)
        .join('');
      document.getElementById('chatInput').value = transcript;
    };
    
    recognition.onend = () => {
      isListening = false;
      document.getElementById('voiceBtn').classList.remove('listening');
      if (document.getElementById('chatInput').value.trim()) {
        sendMessage();
      }
    };
    
    recognition.onerror = (e) => {
      console.error('Speech recognition error:', e.error);
      isListening = false;
      document.getElementById('voiceBtn').classList.remove('listening');
    };
  }
}

document.getElementById('voiceBtn').onclick = () => {
  if (!recognition) {
    alert('Voice recognition not supported in this browser. Try Chrome.');
    return;
  }
  
  if (isListening) {
    recognition.stop();
  } else {
    isListening = true;
    document.getElementById('voiceBtn').classList.add('listening');
    recognition.start();
    addActivity('default', 'Voice Activated', 'Listening for speech input...');
  }
};

// Initialize
initVoice();
console.log('BidDeed.AI Conversational Agent initialized with', FORECLOSURES.length, 'properties');
</script>
</body>
</html>
